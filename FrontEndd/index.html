<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Home</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- ‚úÖ Navbar -->
    <nav
      class="navbar fixed-top navbar-expand-sm navbar-dark"
      style="background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);"
    >
      <div class="container-fluid justify-content-end">
        <button
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          class="navbar-toggler me-auto"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <a href="index.html" class="nav-link active">Home</a>
            <a href="loginPage.html" class="nav-link active">Login</a>
            <a href="AboutUs.html" class="nav-link active">About Us</a>
            <a href="mailto:eslamyasen2@gmail.com" class="nav-link active">Contact Us</a>
          </ul>
        </div>
      </div>
    </nav>

    <!-- ‚úÖ Main Content -->
    <div class="container" style="margin-top: 100px; text-align: center;">
      <h2 class="mb-4">Express your opinion below:</h2>

      <form id="feedbackForm">
        <div class="mb-3">
          <textarea
            id="opinion"
            required
            placeholder="Please share your thoughts here..."
            class="form-control"
            rows="5"
          ></textarea>
        </div>
        <div class="text-center">
          <button id="micButton" type="button" class="btn btn-secondary me-2">üé§ Speak</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>

      <!-- ‚úÖ message area -->
      <div id="feedbackMessage" class="mt-3"></div>
    </div>

    <!-- üéôÔ∏è Speech recognition -->
    <script>
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = "en-US";

        const micButton = document.getElementById("micButton");
        const output = document.getElementById("opinion");

        micButton.addEventListener("click", () => {
          recognition.start();
          micButton.textContent = "üéôÔ∏è Listening...";
          micButton.classList.add("listening");
        });

        recognition.onresult = (event) => {
          let transcript = "";
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          output.value = transcript;
        };

        recognition.onend = () => {
          micButton.textContent = "üé§ Speak";
          micButton.classList.remove("listening");
        };
      } else {
        alert("Sorry, your browser does not support speech recognition.");
      }
    </script>

    <!-- ‚úÖ Auto token generation and feedback submission -->
    <script>
      let token = null;

      // Generate token automatically on page load
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const res = await fetch("http://localhost/MyProject/backend/generate_token.php");
          const data = await res.json();

          if (data.success && data.token) {
            token = data.token;
            console.log("‚úÖ Token generated:", token);
          } else {
            console.error("Token generation failed", data);
            alert("‚ö†Ô∏è Could not generate token automatically.");
          }
        } catch (err) {
          console.error("Error generating token:", err);
          alert("‚ö†Ô∏è Could not connect to backend.");
        }
      });

      // Send feedback
      document.querySelector("#feedbackForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const message = document.querySelector("#opinion").value.trim();
        const feedbackBox = document.querySelector("#feedbackMessage");

        if (!message) {
          alert("Please enter your feedback first.");
          return;
        }
        if (!token) {
          alert("‚ö†Ô∏è No valid token. Please refresh the page.");
          return;
        }

        try {
          const res = await fetch("http://localhost/MyProject/backend/feedback.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, message }),
          });

          const data = await res.json();

          if (data.success) {
            feedbackBox.innerHTML = `
              <div class="alert alert-success text-center mt-3">
                ‚úÖ Thank you for your feedback!
              </div>`;
            document.querySelector("#opinion").value = "";
          } else {
            feedbackBox.innerHTML = `
              <div class="alert alert-warning text-center mt-3">
                ‚ö†Ô∏è ${data.error || "Error while submitting."}
              </div>`;
          }
        } catch (err) {
          console.error(err);
          feedbackBox.innerHTML = `
            <div class="alert alert-danger text-center mt-3">
              ‚ö†Ô∏è Could not connect to the server.
            </div>`;
        }
      });
    </script>
  </body>
</html>
